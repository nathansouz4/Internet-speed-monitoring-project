import sched
import numpy as np
import pandas as pd
import time
from datetime import datetime
import speedtest
import matplotlib.pyplot as plt


st = speedtest.Speedtest()
servernames = [22461]

scheduler = sched.scheduler()

__author__ = "Nathan Souza"
__copyright__ = "Copyright 2021, Monitoring internet speeds project"

# inicializando a lista que ira armazenar os registros de dia/hora/mes/ano
datetime = []

# inicializa as lista/variaveis que irão armazernar as velocidades medidas
down = []
up = []
pi = []
excel_speedtest = pd.DataFrame()
dados_speedtest = pd.DataFrame()


# server 22461: Cabo Servicos de Telecomunicacoes LTDA
# Interface do programa
def print_header():
    """Exibe o cabeçalho da aplicação"""
    print('------------------------------------------------')
    print('           Teste - Velocidade Internet          ')
    print('------------------------------------------------')


print(f'Author:{__author__}\n{__copyright__}\n')
print_header()
print('Para interromper o programa, pressione Crtl+C.\n')


def test_internet_speed():
    print('\nTestando a velocidade...\n')
    aux_download = []
    aux_upload = []
    aux_pi = []
    aux_datetime = []
    # calcula velocidades de rede
    aux_download = '{:.2f}'.format(st.download() / (10 ** 6))
    aux_upload = '{:.2f}'.format(st.upload() / (10 ** 6))
    aux_ping = st.results.ping
    # Registra os horarios e dia da medição das velocidades de rede
    aux_datetime = time.ctime()
    # armazena numa lista
    down.append(aux_download)
    up.append(aux_upload)
    pi.append(aux_ping)
    datetime.append(aux_datetime)
    # roda o comando de sched
    print('\n O próximo teste será realizado em 50 segundos...\n')
    scheduler.enter(delay=5, priority=0, action=test_internet_speed)


def df_speedtest():
    # Cria o dataframe com os dados de velocidades de rede registradas pelo programa
    data_speeds = {'Download': down, 'Upload': up, 'Ping': pi}
    data_speeds = pd.DataFrame(data_speeds, columns=['Download', 'Upload', 'Ping'])
    # convertendo os dados de saida para float
    # data_speeds = data_speeds.apply(pd.to_numeric)
    # cria o dataframe de horarios de realizacao dos testes de velocidade
    date_time = {'Datetime': datetime, }
    df_date_time = pd.DataFrame(date_time, columns=['Datetime'])
    # Junta os dois dataframe
    dados_speedtest = pd.concat([df_date_time, data_speeds], axis=1, join='inner')
    print(dados_speedtest.to_markdown())
    scheduler.enter(delay=35, priority=1, action=df_speedtest)


def save_dataframe():
    global excel_speedtest
    # Cria o dataframe com os dados de velocidades de rede registradas pelo programa
    data_speeds = {'Download': down, 'Upload': up, 'Ping': pi}
    data_speeds = pd.DataFrame(data_speeds, columns=['Download', 'Upload', 'Ping'])
    # cria o dataframe de horarios de realizacao dos testes de velocidade
    date_time = {'Datetime': datetime, }
    df_date_time = pd.DataFrame(date_time, columns=['Datetime'])
    # Junta os dois dataframe
    excel_speedtest = pd.concat([df_date_time, data_speeds], axis=1, join='inner')
    excel_speedtest.to_csv("dados_Speedtest.csv")


#funcao para converter a saida srt p float 
def magic():
    global down
    global up
    global pi
    ##Convertendo a lista para float
    down = [float(i) for i in down]
    up = [float(i) for i in up]
    pi = [float(i) for i in pi]
    return


def internet_graphs():
    plt.style.use("ggplot")
    x_pi = len(pi)
    # array com amostras das quantidades de testes de velocidade de rede realizados
    tests = np.linspace(start=0, stop=x_pi, num=x_pi)
    # criando as figuras
    fig1, ax1 = plt.subplots(figsize=(10, 5))
    fig2, ax2 = plt.subplots(figsize=(10, 5))
    fig3, ax3 = plt.subplots(figsize=(10, 5))
    # plotando os graficos
    ax1.plot(tests, down, color='r', label='Download Speed')
    ax1.set(xlabel="Testes", ylabel="Velocidade de Download em Mb/s")
    ax2.plot(tests, up, color='b', label=' Upload Speed')
    ax2.set(xlabel="Testes", ylabel="Velocidade de Upload em Mb/s")
    ax3.plot(tests, pi, color='m', label='Ping (ms)')
    ax3.set(xlabel="Testes", ylabel="Ping (ms)")
    fig1.savefig('Download')
    fig2.savefig('Upload')
    fig3.savefig('Ping')
    plt.show()
    print('Gerando gráficos...\n')


test_internet_speed()
df_speedtest()

try:
    scheduler.run(blocking=True)
except KeyboardInterrupt:
    magic()
    save_dataframe()
    internet_graphs()
    print('Programa finalziado!')

